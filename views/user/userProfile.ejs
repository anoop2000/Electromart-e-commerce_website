

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@flaticon/flaticon-uicons/css/all/all.css">
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js"></script>




<!-- Bootstrap CSS -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<%- include("../../views/partials/user/header") %>

<style>
 .card-green {
   background-color: #ADD8E6;
 }
 .main {
   padding: 30px 0;
   margin-bottom: 260px;
 }


 .dashboard-menu {
   background-color: #cce3e6;
   border-radius: 10px;
   padding: 15px;
   box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
 }


 .dashboard-menu .nav-link {
 font-weight: bold;
 color: #30683c;
 box-shadow: 0 4px 10px rgba(123, 131, 112, 0.3), 0 4px 20px rgba(0, 191, 255, 0.2);
 transition: box-shadow 0.3s ease;
}


.dashboard-menu .nav-link:hover {
 color: #00bfff;
 box-shadow: 0 4px 15px rgba(173, 255, 47, 0.5), 0 6px 25px rgba(0, 191, 255, 0.4);
}


 .card {
   border-radius: 10px;
   box-shadow: 0 4px 10px rgba(0, 0, 0, 0.5);
   margin-bottom: 20px;
   width : 900px;
 }


 .card-header {
   background-color: #487379;
   color: white;
   border-radius: 10px 10px 0 0;
 }


 .btn-success {
   background-color: #577194;
   border-color: #6bb87d;
 }


 .btn-success:hover {
   background-color: #506955;
 }


 .form-group {
   margin-bottom: 15px;
 }


 .required {
   color: red;
 }

 .thumbnail {
  width: 75px;
  height: 75px;
  object-fit: cover;
  border-radius: 4px; /* Optional for rounded corners */
}


  @media (max-width: 768px) {
   .dashboard-menu {
     padding: 10px;
   }


   .card {
     margin-bottom: 15px;
   }
 }
 .page-header.breadcrumb-wrap {
 background-color: #eee2e9;
 padding: 15px 0;
}


.breadcrumb {
 display: flex;
 align-items: center;
 font-family: 'Arial', sans-serif;
 font-size: 16px;
 color: #121311;
}


.breadcrumb a {
 color: #007bff;
 text-decoration: none;
 position: relative;
 margin: 0 5px;
}


.breadcrumb a:hover {
 color: #0056b3;
}


.breadcrumb span {
 margin: 0 5px;
 color: #999;
}


.breadcrumb a::after {
 content: '';
 position: absolute;
 width: 100%;
 height: 2px;
 background: #6e6e3a;
 left: 0;
 bottom: -2px;
 transform: scaleX(0);
 transition: transform 0.3s ease;
}


.breadcrumb a:hover::after {
 transform: scaleX(1);
}


.btn-small {
    color: #17a2b8; 
    text-decoration: none;
    font-size: 14px;
    padding: 5px 10px;
    border: 1px solid transparent;
    border-radius: 3px;
    transition: color 0.3s ease, text-decoration 0.3s ease;

}
.btn-small:hover {
    color: rgb(208, 35, 26) !important; 
    text-decoration: underline;
}


.btn-small:focus,
.btn-small:active {
    color: #17a2b8; 
    text-decoration: none; 
    outline: none; 
}


.btn-small:visited {
    color: #17a2b8; 
    text-decoration: none;
}
.card-address{
  width : 300px;
  background-color: rgb(234, 227, 227);
}


</style>


<main class="main">
 <div class="page-header breadcrumb-wrap mb-3">
   <div class="container">
     <div class="breadcrumb">
       <a href="#" rel="nofollow">Home</a>
       <span></span> Profile <span></span> Account
     </div>
   </div>
 </div>
  <section class="pt-10 pb-10">
   <div class="container">
     <div class="row">
       <div class="col-lg-10 m-auto">
         <div class="row">
           <div class="col-md-4">
             <div class="dashboard-menu">
               <ul class="nav flex-column" role="tablist">
                 <li class="nav-item">
                   <a class="nav-link active" id="dashboard-tab" data-bs-toggle="tab" href="#dashboard" role="tab" aria-controls="dashboard" aria-selected="false">
                     <i class="fi-rs-settings-sliders mr-10"></i>Dashboard
                   </a>
                 </li>
                 <li class="nav-item">
                   <a class="nav-link" id="address-tab" data-bs-toggle="tab" href="#address" role="tab" aria-controls="address" aria-selected="true">
                     <i class="fi-rs-marker mr-10"></i>My Address
                   </a>
                 </li>
                 <li class="nav-item">
                   <a class="nav-link" id="orders-tab" data-bs-toggle="tab" href="#orders" role="tab" aria-controls="orders" aria-selected="false">
                     <i class="fi-rs-shopping-bag mr-10"></i>Orders
                   </a>
                 </li>
                 <li class="nav-item">
                   <a class="nav-link" id="track-orders-tab" data-bs-toggle="tab" href="#track-orders" role="tab" aria-controls="track-orders" aria-selected="false">
                     <i class="fi-rs-shopping-cart-check mr-10"></i>Wallet Status
                   </a>
                 </li>
                 <li class="nav-item">
                   <a class="nav-link" id="track-orders-tab" data-bs-toggle="tab" href="#wallet-history" role="tab" aria-controls="track-orders" aria-selected="false">
                     <i class="fi-rs-shopping-cart-check mr-10"></i>Wallet History
                   </a>
                 </li>
                 <li class="nav-item">
                   <a class="nav-link" id="track-orders-tab" data-bs-toggle="tab" href="#referal" role="tab" aria-controls="track-orders" aria-selected="false">
                     <i class="fi-rs-shopping-cart-check mr-10"></i>Referals
                   </a>
                 </li>
                 <li class="nav-item">
                   <a class="nav-link" href="/logout">
                     <i class="fi-rs-sign-out mr-10"></i>Logout
                   </a>
                 </li>
               </ul>
             </div>
           </div>
           <div class="col-md-8">
             <div class="tab-content dashboard-content">


               <div class="tab-pane fade show active" id="dashboard" role="tabpanel" aria-labelledby="dashboard-tab">
                 <div class="card card-green">
                   <div class="card-header">
                     <h5 class="mb-0 text-center fw-bold">User Profile</h5>

                   </div>
                   <div class="card-body text-center">
                     <h5 class="card-title" style="font-weight: bold;" ><%=user.name%></h5>
                     <p class="card-text">
                       <strong>Phone: </strong><%=user.phone%>
                     </p>
                     <p class="card-text">
                       <strong>Email: </strong><%=user.email%>
                     </p>

                     <a href="/editProfile" class="btn btn-sm btn-primary me-2">Edit Profile</a>
                     <!-- <a href="/change-email" class="btn btn-sm btn-success ml-2">Change Email</a> -->
                     <a href="/change-password" class="btn btn-sm btn-success">Change Password</a>
                   </div>
                 </div>
               </div>


                <div class="tab-pane fade" id="address" role="tabpanel" aria-labelledby="address-tab">

                 <div class="row">

                  <div>
                    <a href="/addAddress">
                      <button class="btn btn-primary w-70 mb-3">
                        Add address
                      </button>
                    </a>
                  </div>

                  <% if(userAddress) {%>

                    <%userAddress.address.forEach(address => {%>

                     <div class="col-lg-6">
                        <div class="card-address mb-3 mb-lg-0">
                        <div class="card-header">
                            <h5 class="mb-0"><%=address.addressType%></h5>
                        </div>


                       <div class="card-body">
                         <address>
                          <%=address.name%><br/>
                          <%=address.city%><br/>
                          <%=address.landMark%><br/>
                          <%=address.state%><br/>
                          
                         </address>
                         <p><%=address.pincode%></p>
                         <p><%=address.phone%></p>
                         <p><%=address.altPhone%></p>
                         
                      
                         <div class="d-flex justify-content-between">
                           <a href="/edit-address?id=<%=address._id%>" class="btn-small">Edit</a>
                           <a href="/deleteAddress?id=<%=address._id%>" class="btn-small" onclick="return confirm('Are you sure you want to delete this address?')">Delete</a>
                         </div>
                        
                       </div>
                     </div>
                   </div>
                  <%})%><%}else {%>

                
                   <div class="col-lg-6">
                     <div class="card mb-3 mb-lg-0">
                       <div class="card-header">
                         <h5 class="mb-0"></h5>
                       </div>
                       <div class="card-body">
                         <address>No address</address>
                       </div>
                     </div>
                   </div>
                  <%}%>
                   
                 </div>
                </div>





                <div class="tab-pane fade" id="orders" role="tabpanel" aria-labelledby="orders-tab">
  <div class="card">
    <div class="card-header">
      <h5 class="mb-0">Your Orders</h5>
    </div>
    <div class="card-body">
      <div class="table-responsive">
        <table class="table">
          <thead>
            <tr>
              <th>No. of Items</th>
              <th>Payment Method</th>
              <th>Total Amount</th>
              <th>Status</th>
              <th>Order Details</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody>
            <% if (orders && orders.length > 0) { %>
              <% orders.forEach((order, index) => { %>
                <tr id="order-row-<%= order.orderid %>">
                  <td><%= order.orderedItems.length %></td>
                  <td><%= order.paymentType %></td>
                  <td>₹<%= order.finalAmount %></td>
                  <td class="label badge badge-primary"><%= order.status %></td>
                  <td>
                    <!-- <button class="btn btn-info" data-bs-toggle="modal" data-bs-target="#orderDetailsModal-<%= index %>">
                     <a href="/viewDetails?id=<%= order._id %>"> View Details</a>
                    </button> -->



                    
                      <button class="btn btn-primary view-details-button" data-order-id="<%= order._id %>">View Details</button>
                    
                  </td>
                  <td>
                    <button
                      class="cancel-order-button btn btn-danger"
                      data-order-id="<%= order.orderid %>"
                    >
                      Cancel
                    </button>
                  </td>
                </tr>

                <!-- Modal for order details -->
                

                <!-- <div class="modal fade" id="orderDetailsModal" tabindex="-1" aria-labelledby="orderDetailsModalLabel" aria-hidden="true">
                  <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                      <div class="modal-header">
                        <h5 class="modal-title" id="orderDetailsModalLabel">Order Details</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                      </div>
                      <div class="modal-body" id="modalContent"> -->

                        <!-- Content will be injected dynamically -->

                      <!-- </div>
                      <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                      </div>
                    </div>
                  </div>
                </div> -->




                <div class="modal fade" id="orderDetailsModal" tabindex="-1" aria-labelledby="orderDetailsModalLabel" aria-hidden="true">
                  <div class="modal-dialog">
                    <div class="modal-content">
                      <div class="modal-header">
                        <h5 class="modal-title" id="orderDetailsModalLabel">Order Details - <%= order.orderid %></h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                      </div>
                      <div class="modal-body">
                        <h6>Ordered Items</h6>
                        <% order.orderedItems.forEach(item => { %>
                          <div>
                            <strong><%= item.product.productName %></strong>
                            <p>Price: <%= item.price %> | Quantity: <%= item.quantity %></p>
                            
                          </div>
                        <% }) %>
                
                        
                      </div>
                      <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                      </div>
                    </div>
                  </div>
                </div>
                
                
              


                <!--modal end --> 
              <% }); %> <!-- End of orders.forEach -->
            <% } else { %>
              <tr>
                <td colspan="6" style="text-align: center;">No orders found. <a href="/shop" class="btn btn-info">Start shopping!</a></td>
              </tr>
            <% } %>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

                              


               






              


               <div class="tab-pane fade" id="track-orders" role="tabpanel" aria-labelledby="track-orders-tab">
                 <div class="card">
                   <div class="card-header">
                     <h5 class="mb-0">Wallet</h5>
                   </div>
                   <div class="card-body contact-from-area">
                     <div class="row">
                       <div class="col-lg-8 mx-auto text-center mt-90">
                         <form>
                           <div class="form-group">
                             <label for="walletAmount" class="h4">Amount</label>
                             <div class="h3"></div>
                           </div>
                           <button type="button" class="btn btn-success" onclick="">Add Money</button>
                         </form>
                       </div>
                     </div>
                   </div>
                 </div>
               </div>


               <div class="tab-pane fade" id="wallet-history" role="tabpanel" aria-labelledby="orders-tab">
                 <div class="card">
                   <div class="card-header">
                     <h5 class="mb-0">Wallet History</h5>
                   </div>
                   <div class="card-body">
                     <div class="table-responsive">
                       <table class="table">
                         <thead>
                           <tr>
                             <th>Date</th>
                             <th>Status</th>
                             <th>Amount</th>
                           </tr>
                         </thead>
                         <tbody>
                           <tr>
                             <td></td>
                             <td></td>
                             <td></td>
                           </tr>
                         </tbody>
                       </table>
                     </div>
                   </div>
                 </div>
               </div>


               <div class="tab-pane fade" id="referal" role="tabpanel" aria-labelledby="track-orders-tab">
                 <div class="card">
                   <div class="card-header">
                     <h5 class="mb-0">Referal</h5>
                   </div>
                   <div class="card-body">
                     <h6 class="mb-3">Refer your friends and earn money!</h6>
                     <p>Share this link: <strong>></strong></p>
                     <p>Earned: ₹</p>
                   </div>
                 </div>
               </div>
       </div>
     </div>
   </div>
 </section>
</main>



<section>
  <% if (emailUpdated) { %>
      <div id="success-alert" class="alert alert-success" role="alert">
          Email updated successfully! Your email has been changed.
      </div>
      <script>
          document.addEventListener('DOMContentLoaded', () => {
              setTimeout(() => {
                  const alertElement = document.getElementById('success-alert');
                  if (alertElement) {
                      alertElement.style.display = 'none'; 
                  }
              }, 2000); 
          });
      </script>
  <% } %>
</section>





<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>



<script>



document.querySelectorAll('.cancel-order-button').forEach(button => {
    button.addEventListener('click', async () => {
        const orderId = button.getAttribute('data-order-id'); // Get the correct order ID

        // Confirmation prompt using SweetAlert
        const result = await Swal.fire({
            title: 'Are you sure?',
            text: 'Do you want to cancel the order?',
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#3085d6',
            cancelButtonColor: '#d33',
            confirmButtonText: 'Yes, cancel it!',
        });

        if (result.isConfirmed) {
            try {
                const response = await fetch(`/cancelOrder/${orderId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        Authorization: `Bearer ${localStorage.getItem('token')}`,
                    },
                });

                const data = await response.json();

                if (response.status === 200) {
                    // Show success alert
                    Swal.fire({
                        icon: 'success',
                        title: 'Order Cancelled',
                        text: data.message,
                    });

                    // Update the status on the frontend instantly
                    const row = document.querySelector(`#order-row-${orderId}`);
                    if (row) {
                        const statusCell = row.querySelector('.label'); // Assuming 'label' is the class for the status element
                        if (statusCell) {
                            statusCell.textContent = 'Cancelled';
                            statusCell.classList.remove('badge-primary', 'badge-success'); // Remove other status classes
                            statusCell.classList.add('badge-danger'); // Add class for "Cancelled"
                        }
                    }
                } else {
                    Swal.fire({
                        icon: 'error',
                        title: 'Unable to Cancel Order',
                        text: data.message,
                    });
                }
            } catch (error) {
                console.error('Error cancelling order:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'An error occurred while attempting to cancel the order.',
                });
            }
        }
    });
});










</script>



<script>



document.addEventListener('DOMContentLoaded', () => {
  const viewDetailsButtons = document.querySelectorAll('.view-details-button');

  viewDetailsButtons.forEach((button) => {
    button.addEventListener('click', async () => {
      const orderId = button.dataset.orderId;

      try {
        const response = await fetch(`/viewDetails?id=${orderId}`);
        const data = await response.json();

        if (data.success) {
          const order = data.order;

          // Build address details
          const addressContent = order.address && order.address.address
            ? order.address.address.map(addr => `
                <p>
                  <strong>Type:</strong> ${addr.addressType}<br>
                  <strong>Name:</strong> ${addr.name}<br>
                  <strong>City:</strong> ${addr.city}<br>
                  <strong>Landmark:</strong> ${addr.landMark}<br>
                  <strong>State:</strong> ${addr.state}<br>
                  <strong>Pincode:</strong> ${addr.pincode}<br>
                  <strong>Phone:</strong> ${addr.phone}<br>
                  <strong>Alt Phone:</strong> ${addr.altPhone || 'N/A'}<br>
                </p>
              `).join('')
            : '<p>No delivery address available.</p>';

          // Inject address into modal content
          const modalContent = `
            <h6>Delivery Address:</h6>
            ${addressContent}
          `;

          document.getElementById('modalContent').innerHTML = modalContent;

          // Show the modal
          const orderDetailsModal = new bootstrap.Modal(document.getElementById('orderDetailsModal'));
          orderDetailsModal.show();
        } else {
          alert('Error fetching order details.');
        }
      } catch (err) {
        console.error(err);
        alert('Server error. Please try again.');
      }
    });
  });
});

  




 
</script>












<%- include("../../views/partials/user/footer") %>





